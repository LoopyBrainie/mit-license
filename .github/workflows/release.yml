# actionlint: allow-secrets CHOCO_API_KEY

name: Chocolatey Publish

on:
  push:
    tags:
      - 'v*'

env:
  CARGO_TERM_COLOR: always

jobs:
  chocolatey:
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: stable
          override: true
          target: x86_64-pc-windows-msvc

      - name: Build release binary
        run: cargo build --release --target x86_64-pc-windows-msvc

      - name: Prepare Chocolatey package files
        shell: pwsh
        run: |
          $tag = "${{ github.ref_name }}"
          $version = $tag -replace '^v', ''
          $zipPath = "auto-mit-x86_64-pc-windows-msvc.zip"

          if (Test-Path $zipPath) {
            Remove-Item $zipPath -Force
          }

          Compress-Archive -Path target/x86_64-pc-windows-msvc/release/auto-mit.exe -DestinationPath $zipPath

          $hash = (Get-FileHash $zipPath -Algorithm SHA256).Hash

          $nuspec = Get-Content auto-mit.nuspec -Raw
          $nuspec = $nuspec -replace '<version>.*</version>', "<version>$version</version>"
          Set-Content auto-mit.nuspec $nuspec

          $installScript = Get-Content tools/chocolateyinstall.ps1 -Raw
          $installScript = $installScript -replace '__VERSION__', $tag
          $installScript = $installScript -replace '__CHECKSUM__', $hash
          Set-Content tools/chocolateyinstall.ps1 $installScript

          Write-Host "Prepared Chocolatey package for version $version with checksum $hash"

      - name: Ensure Chocolatey
        shell: pwsh
        run: |
          if (!(Get-Command choco -ErrorAction SilentlyContinue)) {
            Set-ExecutionPolicy Bypass -Scope Process -Force
            [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072
            iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))
          }

      - name: Pack Chocolatey package
        shell: pwsh
        run: |
          Get-ChildItem -Filter "auto-mit.*.nupkg" | Remove-Item -ErrorAction SilentlyContinue
          choco pack auto-mit.nuspec

      - name: Ensure GitHub release
        shell: pwsh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          $tag = "${{ github.ref_name }}"
          gh release view $tag --json url *> $null
          if ($LASTEXITCODE -ne 0) {
            gh release create $tag --title $tag --notes ""
          }

      - name: Upload release assets
        shell: pwsh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          $tag = "${{ github.ref_name }}"
          $nupkg = Get-ChildItem -Filter "auto-mit.*.nupkg" | Select-Object -First 1
          if (-not $nupkg) {
            Write-Error "No Chocolatey package found to upload."
          }

          gh release upload $tag `
            auto-mit-x86_64-pc-windows-msvc.zip `
            $nupkg.FullName `
            --clobber

      - name: Push to Chocolatey
        shell: pwsh
        env:
          CHOCO_API_KEY: ${{ secrets.CHOCO_API_KEY }}
        run: |
          if (-not $env:CHOCO_API_KEY) {
            Write-Error "CHOCO_API_KEY secret is not configured."
          }

          $nupkg = Get-ChildItem -Filter "auto-mit.*.nupkg" | Select-Object -First 1
          choco push $nupkg.Name --source https://push.chocolatey.org/ --api-key $env:CHOCO_API_KEY
